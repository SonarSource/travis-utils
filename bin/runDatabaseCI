#!/bin/bash
# Usage: runDatabaseCI "database" "jdbc_url" "login" "pwd"

set -euo pipefail

# Build current version of SonarQube (Don't create a zip)
mvn install -DskipTests -Pdev -Dassembly.format=dir -Dchecksum.failOnError=false -T2 -Dsource.skip=true

# Start server
cd sonar-application/target/sonarqube-*/sonarqube-*
(exec java -jar lib/sonar-application-*.jar \
  -Dsonar.log.console=true \
  -Dsonar.jdbc.url=$2 -Dsonar.jdbc.username=$3 -Dsonar.jdbc.password=${4:-} \
  -Dsonar.web.javaAdditionalOpts="-Djava.security.egd=file:/dev/./urandom"
  "$@") &
pid=$!

# Wait for server to be up and running
for i in {1..30}; do
  set +e
  curl -s http://localhost:9000/api/system/status | grep "UP"
  retval=$?
  set -e
  if [ $retval -eq 0 ]; then
    # Success. Let's stop the server
    # Should we use orchestrator's stop command?
    kill -9 $pid

    # Run the tests
    cd ../../../..
    mvn package -pl :sonar-db -am -PdbTests -Dsonar.jdbc.dialect=$1 -Dsonar.jdbc.url=$2 -Dsonar.jdbc.username=$3 -Dsonar.jdbc.password=${4:-} -V
    exit $?
  fi

  sleep 1
done

# Failed to start
exit 1
