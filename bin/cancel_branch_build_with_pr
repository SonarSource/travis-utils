#!/bin/bash
# Usage: cancel_branch_build_with_pr
#
# Only work in travis environment with GITHUB_TOKEN env var set
# when a job is cancelled it will appear as 
#  - a cancelled job on travis
#  - a cancelled job on burgr
#  - a failed check in github commit statuses

CURL_SILENT_CMD="curl --write-out %{http_code} --silent"
CURL_VERBOSE_CMD="curl --write-out %{http_code}"
CURL_CMD=$CURL_VERBOSE_CMD

if [[ $TRAVIS_BRANCH != *"master" ]]; then
    if [ -n "${GITHUB_TOKEN:-}" ]; then    
        if [ "$TRAVIS_PULL_REQUEST" == "false" ]; then 
            #if we are not in a pullrequest build and the current branch has a pull request open, cancel job        
            PULL_REQUEST_STATUS=`curl --silent "https://api.github.com/repos/$TRAVIS_REPO_SLUG/pulls?access_token=$GITHUB_TOKEN&head=SonarSource:$TRAVIS_BRANCH&state=open" | jq -r .[0].state`            

            if [ "$PULL_REQUEST_STATUS" == "open" ]; then
                echo "======= branch with open pull request, exiting the build ======="
                exit 0  
            else
                echo "======= branch with no open pull request, building ======="
            fi
        else
            echo "======= in a pull request: building ======="
        fi
    else
        echo "======= Can not connect to github without a token set in GITHUB_TOKEN environment variable ======="
    fi
fi